# Архитектура системы плагинов

Данный документ описывает архитектуру системы плагинов, их контракт, жизненный цикл и требования к реализации. Он предназначен для разработчиков, создающих плагины, а также для тех, кто расширяет или сопровождает ядро системы.

---

## Общая концепция

Система плагинов предоставляет **структурированный и предсказуемый подход** к созданию расширяемых компонентов с чётко определённым жизненным циклом.

Ключевые принципы:

* единый контракт плагина;
* централизованное управление состояниями;
* формализованная машина состояний (state machine);
* изоляция плагинов от runtime‑логики.

Все плагины:

* наследуются от базового абстрактного класса;
* управляются через менеджер жизненного цикла;
* взаимодействуют с системой только через определённые действия и состояния.

---

## Базовые сущности плагина

### PluginBase (ABC)

Абстрактный базовый класс, **обязательный для наследования всеми плагинами**. Определяет минимальный контракт и набор методов, которые должен реализовать каждый плагин.

Назначение:

* зафиксировать обязательный интерфейс плагина;
* обеспечить совместимость с lifecycle-менеджером;
* предотвратить использование некорректных плагинов.

Расположение:

* `src/plugin_factory/core/plugins/plugin_base.py`

---

### PluginInfo (dataclass)

`PluginInfo` - dataclass для хранения **метаинформации о плагине**.

Содержит, например:

* имя плагина (обязательно);
* описание;
* первоначальное состояние (выставляется автоматически при создание экземпляра)
* ошибки (заполняется при возникновение ошибок в ходе эксплуатации)
* дополнительные атрибуты, расширяемые в будущем.

Требования:

* метаинформация должна быть **доступна только на чтение**;
* допускается расширение структуры, но не изменение существующих полей.

Расположение:

* `src/plugin_factory/core/plugins/plugin_info.py`

---

### PluginMethod (StrEnum)

Перечень методов, которые **обязаны быть реализованы в плагине**.

Назначение:

* формализовать контракт на уровне перечислений;
* обеспечить соответствие между abstract-методами `PluginBase` и реальной реализацией плагина;
* использоваться при валидации плагинов.

Важно:

* список методов **должен строго соответствовать** abstract-методам `PluginBase`.

Расположение:

* `src/plugin_factory/core/plugins/plugin_method.py`

---

## Управление жизненным циклом плагина

### LifecycleManager

`LifecycleManager` - компонент, обращений к плагинам.

Ответственность:

* применение действий пользователя к плагину;
* вызов FSM.

Инициализация:

* менеджер принимает таблицу переходов, реализующую `FSM_TRANSITIONS`;
* не содержит жёстко зашитой логики переходов.

Расположение:

* `src/plugin_factory/infrastructure/state_machine/lifecycle_manager.py`

---

### LifecycleTransitions

Компонент, инкапсулирующий логику переходов между состояниями.

Характеристики:

* создаётся и инициализируется внутри `LifecycleManager`;
* работает исключительно с `FSM_TRANSITIONS`;
* не содержит бизнес‑логики плагинов;
* перевод плагина в корректное состояние при ошибках;
* координация переходов между состояниями.

Расположение:

* `src/plugin_factory/infrastructure/state_machine/lifecycle_transitions.py`

---

## Машина состояний (State Machine)

### FSM_TRANSITIONS

Таблица переходов, определяющая:

* из какого состояния;
* при каком действии;
* в какое новое состояние

может быть переведён плагин.

Назначение:

* централизовать правила переходов;
* исключить невалидные сценарии использования;
* упростить расширение lifecycle.

Расположение:

* `src/plugin_factory/core/state_machine/fsm_transition.py`

---

### ACTION_METHOD_MAP

Компонент сопоставления **действия → метода плагина**.

Используется для:

* определения, какой метод плагина вызывается при конкретном действии;
* действия в FSM не приравнивается по количеству и именованию методу плагина;
* проверки соответствия реализации плагина контракту.

Расположение:

* `src/plugin_factory/core/state_machine/action_method_map.py`

---

### FSMAction

Перечень допустимых действий, которые могут быть применены к плагину.

Примеры:

* инициализация;
* запуск;
* остановка.

Используется:

* lifecycle‑менеджером;
* таблицей переходов;

Расположение:

* `src/plugin_factory/core/state_machine/fsm_action.py`

---

### FSMState

Перечень возможных состояний плагина.

Назначение:

* формализация жизненного цикла;
* контроль допустимых переходов.

Расположение:

* `src/plugin_factory/core/state_machine/fsm_state.py`

---

## Требования к реализации плагинов

При разработке плагинов **обязательно** должны соблюдаться следующие требования:

1. **Наследование**

   * каждый плагин обязан наследоваться от `PluginBase`.

2. **Соответствие методов**

   * abstract-методы `PluginBase` должны полностью совпадать с перечнем `PluginMethod`.

3. **Метаинформация**

   * метаданные плагина должны быть доступны через свойство `info` (существует в базовом классе);
   * у плагина должно быть заполнено поле `NAME: str`
   * метод `_apply_info` используется для заполнения `PluginInfo` при создание экземпляра;
   * допускается только расширение.

4. **Обработка ошибок**

   * любые необработанные ошибки плагина должны переводить его в состояние `FAILED`;
   * FSM ожидает от плагина сообщение об ошибке для внесения в `PluginInfo` и смены состояния.

5. **Переходы состояний**

   * все изменения состояния плагина обязаны соответствовать таблице переходов;
   * прямое изменение состояния запрещено.

---

## Архитектурные гарантии

Соблюдение описанных принципов обеспечивает:

* предсказуемый жизненный цикл плагинов;
* безопасное расширение системы;
* изоляцию ошибок плагинов от ядра.




## API для пользователя (Будет дополнено/изменено)

* `PluginBase` - базовый класс для наследования плагинами и соблюдения контракта;
* `FinderStorage` - датакласс для поиска плагинов;
* `Lifecycle` - FSM;
* `PluginManager` - поиск, валидация, создание экземпляра и загрузка плагинов;

```
class FinderStorage:
    pattern: str # шаблон для именования файлов являющиемся плагинами
    path: Path # место хранение плагинов
```
```
Пример:
    plugin_dir = Path(__file__).parent / "plugins"
    pattern = "plugin*.py"

    plugin_files = FinderStorage(pattern, plugin_dir)
```
